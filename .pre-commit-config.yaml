# Pre-commit hooks for Aurora testing infrastructure
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files
# See: https://pre-commit.com

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
        exclude: '^(\.github/|docs/.*\.md$)'

      - id: end-of-file-fixer
        name: Ensure files end with newline
        exclude: '^(\.github/|docs/.*\.md$)'

      - id: check-yaml
        name: Check YAML syntax
        args: ['--allow-multiple-documents']

      - id: check-json
        name: Check JSON syntax

      - id: check-toml
        name: Check TOML syntax

      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=500']

      - id: check-merge-conflict
        name: Check for merge conflicts

      - id: debug-statements
        name: Check for debug statements (pdb, ipdb)
        exclude: '^(tests/|.*fixtures/sample_python_files/broken\.py$)'

      - id: mixed-line-ending
        name: Check for mixed line endings
        args: ['--fix=lf']

  # Python code formatting
  - repo: https://github.com/psf/black
    rev: 26.1.0
    hooks:
      - id: black
        name: Format Python code with Black
        args: ['--line-length=100']
        exclude: '.*fixtures/.*broken\.py$'

  # Python import sorting
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: Sort Python imports with isort
        args: ['--profile=black', '--line-length=100']

  # Python linting
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: Lint Python code with flake8
        args: [
          '--max-line-length=100',
          '--extend-ignore=E203,W503,E501,E722,E721,F841,E402,F541,E731',  # Black compatibility + test/script leniency
          '--exclude=.git,__pycache__,build,dist,*.egg-info,**/fixtures/sample_python_files/broken.py'
        ]

  # Python type checking (optional, can be slow)
  # - repo: https://github.com/pre-commit/mirrors-mypy
  #   rev: v1.8.0
  #   hooks:
  #     - id: mypy
  #       name: Type check with mypy
  #       args: ['--ignore-missing-imports', '--no-strict-optional']
  #       additional_dependencies: [types-all]

  # Custom Aurora validation hooks
  - repo: local
    hooks:
      - id: validate-imports
        name: Validate import patterns (aurora_* not aurora.*)
        entry: python3 scripts/validate_imports.py
        language: system
        types: [python]
        pass_filenames: true
        stages: [pre-commit]
        exclude: '^scripts/(validate_imports|revert_init_imports|migrate_imports)\.py$'

      - id: validate-test-classification
        name: Validate test classification (unit/integration/e2e)
        entry: python3 scripts/validate_test_classification.py
        language: system
        types: [python]
        files: '^tests/.*\.py$'
        pass_filenames: false
        stages: [pre-commit]

      - id: validate-marker-usage
        name: Validate pytest marker usage
        entry: python3 scripts/validate_marker_usage.py
        language: system
        types: [python]
        files: '^tests/.*\.py$'
        pass_filenames: false
        stages: [pre-commit]

  # Security checks
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        name: Security check with Bandit
        args: ['-ll', '--skip=B101,B601,B103,B301,B306']  # Skip test-specific patterns
        exclude: '^(tests/|packages/.*/tests/|.*_test\.py$|test_.*\.py$|compare_batch_sizes\.py|profile_.*\.py|benchmark_.*\.py)'

  # Documentation
  - repo: https://github.com/pycqa/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        name: Check docstring style
        args: ['--convention=google', '--add-ignore=D100,D101,D102,D103,D104,D105,D106,D107,D202,D205,D209,D300,D301,D402,D403,D415']
        exclude: '^(tests/|packages/.*/tests/|packages/.*/fixtures/|docs/archive/|.*_test\.py$|test_.*\.py$|compare_batch_sizes\.py|profile_.*\.py|benchmark_.*\.py|saas_financial_model\.py)'

# Configuration
default_language_version:
  python: python3

# Global settings
fail_fast: false  # Run all hooks even if one fails
default_stages: [pre-commit]

# Exclude patterns (applied to all hooks unless overridden)
exclude: |
  (?x)^(
    \.git/|
    \.venv/|
    \.tox/|
    build/|
    dist/|
    .*\.egg-info/|
    __pycache__/|
    \.pytest_cache/|
    \.mypy_cache/|
    \.coverage|
    htmlcov/|
    \.DS_Store|
    .*~|
    \.swp|
    migrations/|
    alembic/versions/
  )$
