# Plan: Fix aur:plan Goals Integration & Add aur:proposal Command

## Problem Summary

Two issues identified with Aurora slash commands:

1. **Issue #1**: `/aur:plan` doesn't properly consume `goals.json` generated by `aur goals`
   - Template doesn't reference goals.json
   - No enforcement to include subgoals, agents, or memory_context
   - Hard to tell if aur:plan used the goals.json at all

2. **Issue #2**: Missing `aur:proposal` command (OpenSpec equivalent)
   - OpenSpec has `openspec:proposal` which converts PRD into specs + tasks
   - Aurora's `aur:plan` is action-focused, not spec-focused
   - No spec delta generation (ADDED/MODIFIED/REMOVED Requirements)

## Design Decisions

- **Separate commands**: Keep `aur:plan` for action-focused planning, add `aur:proposal` for spec-delta generation
- **Exact OpenSpec port**: Both `aur:plan` and `aur:proposal` templates are exact ports from OpenSpec's refactored `proposal` template (only rebrand paths/commands from `openspec` to `aur`/`.aurora`)
- **aur:plan works with AND without goals.json**:
  - WITH goals.json: Read and integrate subgoals/agents into plan.md
  - WITHOUT goals.json: Use template directly (still works)
- **Fallback if aur goals optimization fails**: Update aur:plan to self-capture agents list (`aur agents list`) and add suggested agents directly to plan.md

## Prerequisite: Fix `aur goals` Memory Retrieval Quality

**Problem discovered**: Comparing goals.json vs what `/aur:plan` actually found:

| goals.json memory_context | Relevance | Issue |
|---------------------------|-----------|-------|
| `docs/development.md` | 0.82 | Docs, not code |
| `docs/architecture.md` | 0.71 | Docs, not code |
| `.claude/commands/openspec/archive.md` | 0.66 | **NOISE** - unrelated |
| `.claude/commands/openspec/proposal.md` | 0.58 | **NOISE** - unrelated |

| What /aur:plan found manually | Why it matters |
|-------------------------------|----------------|
| `memory_manager.py` | **THE CORE FILE** |
| `store/sqlite.py` | Critical implementation |
| `hybrid_retriever.py` | Critical implementation |
| `bm25_scorer.py` | Critical implementation |

**Conclusion**: `aur goals` retrieves docs and noise instead of actual code. Integrating goals.json into aur:plan now would **pollute** the plan, not help it.

**Required fix before Issue #1**:
- Filter `aur goals` memory retrieval to code chunks only
- Or add `--code-only` flag to exclude docs/markdown/config
- Or weight code chunks significantly higher than docs
- File to fix: `packages/cli/src/aurora_cli/commands/goals.py` (memory search call)

**Note**: This is an OPTIMIZATION, not a blocker. aur:plan works without goals.json. If this optimization fails, aur:plan has a fallback to self-capture agents.

## Solution Design

### Fix #1: Replace PLAN_TEMPLATE with exact OpenSpec port

**Status**: READY - Works with or without goals.json. Has fallback if aur goals optimization fails.

**File**: `packages/cli/src/aurora_cli/templates/slash_commands.py`

Replace current loose PLAN_TEMPLATE with exact port of OpenSpec's proposal template (only rebrand paths/commands).

**Exact PLAN_TEMPLATE (ported from OpenSpec proposal, ONLY path/command rebranding):**

```python
# Plan-specific guardrails (extends BASE_GUARDRAILS)
PLAN_GUARDRAILS = f"""{BASE_GUARDRAILS}
- Identify any vague or ambiguous details and ask the necessary follow-up questions before editing files.
- Do not write any code during the planning stage. Only create design documents (plan.md, tasks.md, design.md, and spec deltas). Implementation happens in the implement stage after approval."""

PLAN_STEPS = """**Steps**
1. Review `.aurora/project.md`, run `aur plan list` and `aur plan list --specs`, and inspect related code or docs (e.g., via `rg`/`ls`) to ground the plan in current behaviour; note any gaps that require clarification.
2. Choose a unique verb-led `plan-id` and scaffold `plan.md`, `tasks.md`, and `design.md` (when needed) under `.aurora/plans/active/<id>/`.
3. Map the change into concrete capabilities or requirements, breaking multi-scope efforts into distinct spec deltas with clear relationships and sequencing.
4. Capture architectural reasoning in `design.md` when the solution spans multiple systems, introduces new patterns, or demands trade-off discussion before committing to specs.
5. Draft spec deltas in `.aurora/plans/active/<id>/specs/<capability>/spec.md` (one folder per capability) using `## ADDED|MODIFIED|REMOVED Requirements` with at least one `#### Scenario:` per requirement and cross-reference related capabilities when relevant.
6. Draft `tasks.md` as an ordered list of small, verifiable work items that deliver user-visible progress, include validation (tests, tooling), and highlight dependencies or parallelizable work.
7. Validate with `aur plan validate <id> --strict` and resolve every issue before sharing the plan."""

PLAN_REFERENCES = """**Reference**
- Use `aur plan show <id> --json --deltas-only` or `aur plan show <spec> --type spec` to inspect details when validation fails.
- Search existing requirements with `rg -n "Requirement:|Scenario:" .aurora/specs` before writing new ones.
- Explore the codebase with `rg <keyword>`, `ls`, or direct file reads so plans align with current implementation realities."""

# Combined template
PLAN_TEMPLATE = f"""{PLAN_GUARDRAILS}

{PLAN_STEPS}

{PLAN_REFERENCES}"""
```

**Goals.json integration** (works with AND without):
- Add to Step 1: "If goals.json exists in the plan directory, read and include subgoals under ## Current System Analysis"
- If NO goals.json: Template still works, just skip subgoals section
- Subgoals format in plan.md (when goals.json present):
```markdown
### Subgoals

> Source: `goals.json` (generated by `aur goals`)

1. **SG-1**: [title]
   - [description]
   - subagent: @agent-id

2. **SG-2**: [title]
   - [description]
   - subagent: @agent-id
   - depends on: SG-1
```

**Fallback** (if aur goals optimization not successful):
- Update aur:plan template to self-capture agents: "Run `aur agents list` and suggest appropriate agents for each subgoal"
- Add suggested agents directly in plan.md without relying on goals.json

### Fix #2: Port Refactored openspec:proposal as aur:proposal

**Source**: `/home/hamr/Documents/PycharmProjects/OpenSpec/src/core/templates/slash-command-templates.ts`

**File to modify**: `packages/cli/src/aurora_cli/templates/slash_commands.py`

Port the **exact** refactored OpenSpec template, rebranded to Aurora. The proposal command outputs to the **same plan directory** where goals.json was created.

**Exact PROPOSAL_TEMPLATE (ported from OpenSpec, ONLY path/command rebranding):**

```python
# Proposal-specific guardrails (extends BASE_GUARDRAILS)
PROPOSAL_GUARDRAILS = f"""{BASE_GUARDRAILS}
- Identify any vague or ambiguous details and ask the necessary follow-up questions before editing files.
- Do not write any code during the proposal stage. Only create design documents (proposal.md, tasks.md, design.md, and spec deltas). Implementation happens in the apply stage after approval."""

PROPOSAL_STEPS = """**Steps**
1. Review `.aurora/project.md`, run `aur plan list` and `aur plan list --specs`, and inspect related code or docs (e.g., via `rg`/`ls`) to ground the proposal in current behaviour; note any gaps that require clarification.
2. Choose a unique verb-led `plan-id` and scaffold `proposal.md`, `tasks.md`, and `design.md` (when needed) under `.aurora/plans/active/<id>/`.
3. Map the change into concrete capabilities or requirements, breaking multi-scope efforts into distinct spec deltas with clear relationships and sequencing.
4. Capture architectural reasoning in `design.md` when the solution spans multiple systems, introduces new patterns, or demands trade-off discussion before committing to specs.
5. Draft spec deltas in `.aurora/plans/active/<id>/specs/<capability>/spec.md` (one folder per capability) using `## ADDED|MODIFIED|REMOVED Requirements` with at least one `#### Scenario:` per requirement and cross-reference related capabilities when relevant.
6. Draft `tasks.md` as an ordered list of small, verifiable work items that deliver user-visible progress, include validation (tests, tooling), and highlight dependencies or parallelizable work.
7. Validate with `aur plan validate <id> --strict` and resolve every issue before sharing the proposal."""

PROPOSAL_REFERENCES = """**Reference**
- Use `aur plan show <id> --json --deltas-only` or `aur plan show <spec> --type spec` to inspect details when validation fails.
- Search existing requirements with `rg -n "Requirement:|Scenario:" .aurora/specs` before writing new ones.
- Explore the codebase with `rg <keyword>`, `ls`, or direct file reads so proposals align with current implementation realities."""

# Combined template
PROPOSAL_TEMPLATE = f"""{PROPOSAL_GUARDRAILS}

{PROPOSAL_STEPS}

{PROPOSAL_REFERENCES}"""
```

**Note**: This exact port requires Aurora CLI to support:
- `aur plan list --specs` (list specs)
- `aur plan validate <id> --strict` (strict validation)
- `aur plan show <id> --json --deltas-only` (JSON output with deltas)
- `aur plan show <spec> --type spec` (show spec by type)

If these commands don't exist yet, they need to be added to match OpenSpec functionality.

**Output Directory**: Same as goals.json location (e.g., `.aurora/plans/active/0001-feature/`)

**Workflow**:
```
aur goals "description"     → .aurora/plans/active/NNNN-slug/goals.json
/aur:plan <path>            → .aurora/plans/active/NNNN-slug/plan.md
/aur:proposal <path>        → .aurora/plans/active/NNNN-slug/proposal.md
                            → .aurora/plans/active/NNNN-slug/tasks.md
                            → .aurora/plans/active/NNNN-slug/design.md (optional)
                            → .aurora/plans/active/NNNN-slug/specs/<capability>/spec.md
```

## Files to Modify

| File | Change | Task |
|------|--------|------|
| `packages/cli/src/aurora_cli/commands/goals.py` | Filter memory retrieval to code chunks only | Task 0 (OPTIMIZATION) |
| `packages/cli/src/aurora_cli/templates/slash_commands.py` | Replace PLAN_TEMPLATE, add PROPOSAL_TEMPLATE | Task 1, Task 2 |
| `packages/cli/src/aurora_cli/configurators/slash/claude.py` | Register `proposal` command | Task 3 |
| `packages/cli/src/aurora_cli/configurators/slash/base.py` | Add `"proposal"` to COMMAND_IDS list | Task 3 |

## Implementation Tasks

### Task 0: Fix `aur goals` Memory Retrieval (OPTIMIZATION) [DONE]
- [x] 0.1 Locate memory search call in `packages/cli/src/aurora_cli/commands/goals.py`
- [x] 0.2 Add filter to retrieve code chunks only (exclude docs, markdown, config files)
- [x] 0.3 Or add `--code-only` flag to the command (used extension-based filter instead)
- [x] 0.4 Test: `aur goals "improve memory indexing"` should return `.py` files, not `.md` files

### Task 1: Replace PLAN_TEMPLATE with exact OpenSpec port
- [x] 1.1 Replace current loose PLAN_TEMPLATE with exact OpenSpec proposal template (rebranded)
- [x] 1.2 Add PLAN_GUARDRAILS, PLAN_STEPS, PLAN_REFERENCES constants
- [x] 1.3 Update COMMAND_TEMPLATES dict with new PLAN_TEMPLATE
- [x] 1.4 Add goals.json integration to Step 1 (conditional: "If goals.json exists...")
- [x] 1.5 **Fallback**: If Task 0 fails, add `aur agents list` step to self-capture agents

### Task 2: Port PROPOSAL_TEMPLATE from OpenSpec (Issue #2) [DONE]
- [x] 2.1 Add PROPOSAL_GUARDRAILS (exact port, rebranded)
- [x] 2.2 Add PROPOSAL_STEPS (exact port, paths changed to `.aurora/`)
- [x] 2.3 Add PROPOSAL_REFERENCES (exact port, commands rebranded)
- [x] 2.4 Add combined PROPOSAL_TEMPLATE
- [x] 2.5 Add `"proposal": PROPOSAL_TEMPLATE` to COMMAND_TEMPLATES dict

### Task 3: Register proposal command for `aur init --config` [DONE]
- [x] 3.1 Add `"proposal"` to COMMAND_IDS in `base.py`
- [x] 3.2 Add FILE_PATHS entry for all 20 tools
- [x] 3.3 Add FRONTMATTER entry with name/description/category/tags
- [x] 3.4 Add DESCRIPTIONS entry for proposal command

### Task 4: Test and validate [DONE]
- [x] 4.1 Run `aur init --config` to regenerate slash commands
- [x] 4.2 Verify `.claude/commands/aur/proposal.md` is created
- [x] 4.3 Test `/aur:plan` with goals.json path - verify Goals Context section
- [x] 4.4 Test `/aur:proposal` generates proposal.md, tasks.md, specs/ in same directory

## Verification

1. **Regenerate slash commands:**
   ```bash
   aur init --config
   ```

2. **Verify command files created:**
   ```bash
   cat .claude/commands/aur/plan.md      # Should include "Goals Context" output format
   cat .claude/commands/aur/proposal.md  # Should exist with exact OpenSpec template
   ```

3. **Test Issue #1 fix (aur:plan + goals.json):**
   ```bash
   aur goals "Add feature X"
   # Note the path: .aurora/plans/active/NNNN-slug/goals.json

   # Invoke /aur:plan with the generated goals.json path
   # Verify plan.md includes:
   # - ## Goals Context section at TOP
   # - Subgoals table with ID, Title, Agent, Confidence, Dependencies
   # - Relevant Files table with File, Relevance
   # - Agent Gaps section
   ```

4. **Test Issue #2 fix (aur:proposal):**
   ```bash
   # Invoke /aur:proposal with the same plan directory
   # Verify it creates IN THE SAME DIRECTORY:
   # - proposal.md
   # - tasks.md (ordered checklist)
   # - design.md (optional, if architectural decisions needed)
   # - specs/<capability>/spec.md with ADDED/MODIFIED/REMOVED Requirements
   ```

5. **Verify workflow integration:**
   ```
   .aurora/plans/active/NNNN-slug/
   ├── goals.json     ← from aur goals
   ├── plan.md        ← from /aur:plan (with Goals Context)
   ├── proposal.md    ← from /aur:proposal
   ├── tasks.md       ← from /aur:proposal
   ├── design.md      ← from /aur:proposal (optional)
   └── specs/         ← from /aur:proposal
       └── <capability>/
           └── spec.md
   ```
